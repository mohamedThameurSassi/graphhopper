name: Build, Test & Mutation Score Check

on: push

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        java-version: [24, 25-ea]

    steps:
      # Checkout
      - uses: actions/checkout@v4

      # Install Java
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: temurin

      # Cache Maven
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build ${{ matrix.java-version }}
        run: mvn -B clean test

      - name: Run PIT Mutation Testing (core module only)
        if: matrix.java-version == '24'
        run: mvn clean install -DskipTests && mvn -pl core org.pitest:pitest-maven:mutationCoverage -DargLine=""

      - name: Extract current PIT score
        if: matrix.java-version == '24'
        id: current
        run: |
          SCORE=$(grep -oPm1 "(?<=<score>)[^<]+" core/target/pit-reports/*/summary.xml || echo 0)
          echo "current_score=$SCORE" >> $GITHUB_OUTPUT
          echo "Current mutation score: $SCORE"

      - name: Get previous PIT score
        if: matrix.java-version == '24'
        id: previous
        run: |
          if [ -f mutation_score.txt ]; then
            PREV=$(cat mutation_score.txt)
          else
            PREV=0
          fi
          echo "previous_score=$PREV" >> $GITHUB_OUTPUT
          echo "Previous mutation score: $PREV"

      - name: Compare scores
        if: matrix.java-version == '24'
        id: compare
        run: |
          CUR=${{ steps.current.outputs.current_score }}
          PREV=${{ steps.previous.outputs.previous_score }}

          echo "üîç Comparing mutation scores..."
          echo "Previous: $PREV"
          echo "Current:  $CUR"

          if [ "$CUR" -lt "$PREV" ]; then
            echo "‚ùå Mutation score decreased! ($CUR < $PREV)"
            exit 1
          fi

          echo "‚úÖ Mutation score OK or improved ($CUR ‚â• $PREV)"

      - name: Save new mutation score
        if: matrix.java-version == '24' && success()
        run: echo "${{ steps.current.outputs.current_score }}" > mutation_score.txt

      - name: Upload Mutation Report
        if: matrix.java-version == '24' && always()
        uses: actions/upload-artifact@v4
        with:
          name: pit-report-${{ github.sha }}
          path: core/target/pit-reports/

      - name: Create Job Summary
        if: matrix.java-version == '24' && always()
        run: |
          echo "## üß¨ Mutation Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Score |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Current Mutation Coverage** | ${{ steps.current.outputs.current_score }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| **Previous Mutation Coverage** | ${{ steps.previous.outputs.previous_score }}% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìÑ [View Full Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY