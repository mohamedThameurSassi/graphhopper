name: Build and Test
on: push
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java-version: [ 24, 25-ea ]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: temurin
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Cache node
        uses: actions/cache@v4
        with:
          path: web-bundle/node
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os}}-node-
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: web-bundle/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml', '**/package.json') }}
          restore-keys: |
            ${{ runner.os}}-node_modules-
      - name: Build ${{ matrix.java-version }}
        run: mvn -B clean test
      - name: Build dependencies for PITest
        run: mvn -B clean install -pl web-api -am
        if: matrix.java-version == '24'
      
      - name: Get changed Java files for mutation testing
        id: changed-files
        if: matrix.java-version == '24'
        run: |
          # Debug git information
          echo "GitHub event: ${{ github.event_name }}"
          echo "Before commit: ${{ github.event.before }}"
          echo "Current HEAD: $(git rev-parse HEAD)"
          
          # Get changed files in this push (comparing with previous commit)
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            # Regular push with previous commit - add error checking
            echo "Trying to get diff from ${{ github.event.before }} to HEAD"
            if git rev-parse --verify ${{ github.event.before }} >/dev/null 2>&1; then
              ALL_CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}..HEAD 2>/dev/null | grep '\.java$' || true)
              if [ $? -eq 0 ] && [ -n "$ALL_CHANGED_FILES" ]; then
                echo "Successfully got diff using ${{ github.event.before }}..HEAD"
              else
                echo "Git diff failed, trying alternative approach"
                ALL_CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | grep '\.java$' || true)
              fi
            else
              echo "Previous commit ${{ github.event.before }} not found, using HEAD~1"
              ALL_CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | grep '\.java$' || true)
            fi
          else
            # First push or other cases - check last few commits
            echo "Using fallback: checking HEAD~3..HEAD"
            ALL_CHANGED_FILES=$(git diff --name-only HEAD~3..HEAD 2>/dev/null | grep '\.java$' || true)
          fi
          
          # If still no files found, check the latest commit only
          if [ -z "$ALL_CHANGED_FILES" ]; then
            echo "No files found in diff, checking latest commit only"
            ALL_CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '\.java$' || true)
          fi
          echo "All changed Java files: $ALL_CHANGED_FILES"
          
          # Get changed main source files (for mutation testing targets)
          MAIN_CHANGED_FILES=$(echo "$ALL_CHANGED_FILES" | grep -v '/test/' || true)
          echo "Changed main source files: $MAIN_CHANGED_FILES"
          
          # Get changed test files (to understand what's being tested)
          TEST_CHANGED_FILES=$(echo "$ALL_CHANGED_FILES" | grep '/test/' || true)
          echo "Changed test files: $TEST_CHANGED_FILES"
          
          # Convert main source files to class names for mutation testing
          CHANGED_CLASSES=""
          for file in $MAIN_CHANGED_FILES; do
            if [[ $file == */src/main/java/* ]]; then
              class_path=${file#*/src/main/java/}
              class_name=${class_path%.java}
              class_name=${class_name//\//.}
              if [ -z "$CHANGED_CLASSES" ]; then
                CHANGED_CLASSES="$class_name"
              else
                CHANGED_CLASSES="$CHANGED_CLASSES,$class_name"
              fi
            fi
          done
          
          # If no main source files changed, but test files did, analyze test files to find target classes
          if [ -z "$CHANGED_CLASSES" ] && [ -n "$TEST_CHANGED_FILES" ]; then
            echo "No main source files changed, but test files were modified."
            echo "Analyzing test files to find target classes..."
            
            for test_file in $TEST_CHANGED_FILES; do
              if [[ $test_file == */src/test/java/* ]]; then
                echo "Analyzing test file: $test_file"
                
                # Extract package info from test file
                test_class_path=${test_file#*/src/test/java/}
                test_package=${test_class_path%/*}
                test_class_name=${test_class_path##*/}
                test_class_name=${test_class_name%.java}
                
                echo "  Test class path: $test_class_path"
                echo "  Test package: $test_package"
                echo "  Test class name: $test_class_name"
                
                # Strategy: Pattern matching on test class name
                potential_classes=""
                if [[ $test_class_name == *Test ]]; then
                  # Remove "Test" suffix: ArrayUtilTest -> ArrayUtil
                  potential_classes="${test_class_name%Test}"
                  echo "  Detected *Test pattern, potential class: $potential_classes"
                elif [[ $test_class_name == *ExtendedTest ]]; then
                  # Remove "ExtendedTest" suffix: ArrayUtilExtendedTest -> ArrayUtil
                  base_name=${test_class_name%ExtendedTest}
                  potential_classes="$base_name ${base_name}Util ${base_name}Helper"
                  echo "  Detected *ExtendedTest pattern, potential classes: $potential_classes"
                fi
                
                # Test each potential class
                for potential_class in $potential_classes; do
                  if [ -n "$potential_class" ]; then
                    full_class_name="${test_package//\//.}.${potential_class}"
                    class_file="core/src/main/java/${test_package}/${potential_class}.java"
                    
                    echo "    Checking for class file: $class_file"
                    if [ -f "$class_file" ]; then
                      echo "Found target class: $full_class_name (inferred from test name)"
                      if [ -z "$CHANGED_CLASSES" ]; then
                        CHANGED_CLASSES="$full_class_name"
                      else
                        CHANGED_CLASSES="$CHANGED_CLASSES,$full_class_name"
                      fi
                      break
                    fi
                  fi
                done
              fi
            done
          fi
          
          if [ -z "$CHANGED_CLASSES" ]; then
            echo "skip_mutation_testing=true" >> $GITHUB_OUTPUT
            echo "No testable classes found for mutation testing"
          else
            echo "changed_classes=$CHANGED_CLASSES" >> $GITHUB_OUTPUT
            echo "skip_mutation_testing=false" >> $GITHUB_OUTPUT
            echo "Classes to test: $CHANGED_CLASSES"
          fi
      
      - name: Run PITest mutation testing on changed classes
        if: matrix.java-version == '24' && steps.changed-files.outputs.skip_mutation_testing == 'false'
        run: |
          echo "Running mutation testing on: ${{ steps.changed-files.outputs.changed_classes }}"
          mvn -pl core org.pitest:pitest-maven:mutationCoverage \
            -DtargetClasses="${{ steps.changed-files.outputs.changed_classes }}" \
            -DtargetTests="${{ steps.changed-files.outputs.changed_classes }}*Test" \
            -DoutputFormats=XML,HTML \
            -Dthreads=2
          
          # Extract current mutation score
          if [ -f "core/target/pit-reports/mutations.xml" ]; then
            MUTATIONS_GENERATED=$(grep -o '<mutation ' core/target/pit-reports/mutations.xml | wc -l || echo "0")
            MUTATIONS_KILLED=$(grep -o 'status="KILLED"' core/target/pit-reports/mutations.xml | wc -l || echo "0")
            if [ "$MUTATIONS_GENERATED" -ne "0" ]; then
              CURRENT_MUTATION_SCORE=$(echo "scale=1; $MUTATIONS_KILLED * 100 / $MUTATIONS_GENERATED" | bc)
              echo "ðŸ§¬ Current Mutation Score: $CURRENT_MUTATION_SCORE% ($MUTATIONS_KILLED/$MUTATIONS_GENERATED)"
              
              # Store current results for comparison
              echo "CURRENT_SCORE=$CURRENT_MUTATION_SCORE" >> $GITHUB_ENV
              echo "CURRENT_KILLED=$MUTATIONS_KILLED" >> $GITHUB_ENV
              echo "CURRENT_TOTAL=$MUTATIONS_GENERATED" >> $GITHUB_ENV
            else
              echo "ðŸ§¬ No mutations generated"
              echo "CURRENT_SCORE=0" >> $GITHUB_ENV
            fi
          fi
      
      - name: Get baseline mutation score from previous commit
        if: matrix.java-version == '24' && steps.changed-files.outputs.skip_mutation_testing == 'false'
        run: |
          # Get previous commit hash
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            PREV_COMMIT="${{ github.event.before }}"
          else
            PREV_COMMIT="HEAD~1"
          fi
          
          echo "Comparing with previous commit: $PREV_COMMIT"
          
          # Stash current changes
          git stash || true
          
          # Checkout previous commit
          git checkout $PREV_COMMIT
          
          # Build and run PITest on previous commit
          mvn -B clean install -pl web-api -am -q || true
          mvn -pl core org.pitest:pitest-maven:mutationCoverage \
            -DtargetClasses="${{ steps.changed-files.outputs.changed_classes }}" \
            -DtargetTests="${{ steps.changed-files.outputs.changed_classes }}*Test" \
            -DoutputFormats=XML \
            -Dthreads=2 \
            --quiet || true
          
          # Extract baseline score
          if [ -f "core/target/pit-reports/mutations.xml" ]; then
            BASELINE_MUTATIONS_GENERATED=$(grep -o '<mutation ' core/target/pit-reports/mutations.xml | wc -l || echo "0")
            BASELINE_MUTATIONS_KILLED=$(grep -o 'status="KILLED"' core/target/pit-reports/mutations.xml | wc -l || echo "0")
            if [ "$BASELINE_MUTATIONS_GENERATED" -ne "0" ]; then
              BASELINE_SCORE=$(echo "scale=1; $BASELINE_MUTATIONS_KILLED * 100 / $BASELINE_MUTATIONS_GENERATED" | bc)
              echo "ðŸ“Š Baseline Mutation Score: $BASELINE_SCORE% ($BASELINE_MUTATIONS_KILLED/$BASELINE_MUTATIONS_GENERATED)"
              echo "BASELINE_SCORE=$BASELINE_SCORE" >> $GITHUB_ENV
            else
              echo "ðŸ“Š No baseline mutations found"
              echo "BASELINE_SCORE=0" >> $GITHUB_ENV
            fi
          else
            echo "ðŸ“Š No baseline mutation report found"
            echo "BASELINE_SCORE=0" >> $GITHUB_ENV
          fi
          
          # Return to current commit
          git checkout -
          git stash pop || true
      
      - name: Check for mutation score regression
        if: matrix.java-version == '24' && steps.changed-files.outputs.skip_mutation_testing == 'false'
        run: |
          CURRENT_SCORE="${{ env.CURRENT_SCORE }}"
          BASELINE_SCORE="${{ env.BASELINE_SCORE }}"
          TOLERANCE=5  # 5% tolerance
          
          echo "=== ðŸ§¬ Mutation Testing Regression Check ==="
          echo "Classes tested: ${{ steps.changed-files.outputs.changed_classes }}"
          echo "Baseline Score: ${BASELINE_SCORE}%"
          echo "Current Score:  ${CURRENT_SCORE}%"
          
          if [ -n "$CURRENT_SCORE" ] && [ -n "$BASELINE_SCORE" ]; then
            # Calculate difference
            DIFF=$(echo "$CURRENT_SCORE - $BASELINE_SCORE" | bc)
            echo "Difference: ${DIFF}%"
            
            # Check for regression (current score lower than baseline by more than tolerance)
            if (( $(echo "$DIFF < -$TOLERANCE" | bc -l) )); then
              echo "âŒ MUTATION SCORE REGRESSION DETECTED!"
              echo "The mutation score dropped by ${DIFF}% (tolerance: ${TOLERANCE}%)"
              echo "ðŸš¨ BUILD FAILED: Please improve your tests to maintain mutation score quality."
              exit 1
            else
              echo "âœ… No significant mutation score regression detected (${DIFF}%)"
            fi
          else
            echo "âš ï¸  Could not compare scores - skipping regression check"
          fi
      
      - name: Upload mutation test reports
        if: always() && matrix.java-version == '24' && steps.changed-files.outputs.skip_mutation_testing == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: mutation-test-reports-build-${{ github.sha }}
          path: core/target/pit-reports/