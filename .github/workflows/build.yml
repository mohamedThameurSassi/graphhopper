name: Build and Test
on: push
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java-version: [ 24, 25-ea ]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for reliable diff detection
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: temurin
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Cache node
        uses: actions/cache@v4
        with:
          path: web-bundle/node
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os}}-node-
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: web-bundle/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml', '**/package.json') }}
          restore-keys: |
            ${{ runner.os}}-node_modules-
      - name: Build ${{ matrix.java-version }}
        run: mvn -B clean test
      - name: Build dependencies for PITest
        run: mvn -B clean install -pl web-api -am
        if: matrix.java-version == '24'
      
      - name: Load Previous PITest History
        if: matrix.java-version == '24' && env.TEST_CHANGES == 'false'
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: pitest-history
          path: core/target/pit-history/
      
      - name: Load Previous PITest Report
        if: matrix.java-version == '24'
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: pit-reports
          path: core/target/pit-reports/
      
      - name: Get changed Java files for mutation testing
        id: changed-files
        if: matrix.java-version == '24'
        run: |
          # Simple and reliable change detection similar to your friend's approach
          echo "=== Detecting Changed Files ==="
          
          # Get all changed Java files between HEAD~1 and HEAD (similar to your friend's approach)
          ALL_CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.java$' || true)
          echo "All changed Java files: $ALL_CHANGED_FILES"
          
          # If no files in HEAD~1 comparison, try current commit only
          if [ -z "$ALL_CHANGED_FILES" ]; then
            echo "No files found with HEAD~1, trying single commit diff..."
            ALL_CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '\.java$' || true)
          fi
          
          # Separate main source files and test files
          MAIN_CHANGED_FILES=""
          TEST_CHANGED_FILES=""
          
          for file in $ALL_CHANGED_FILES; do
            if [[ $file == *"/test/"* ]]; then
              TEST_CHANGED_FILES="$TEST_CHANGED_FILES $file"
            elif [[ $file == *"/src/main/java/"* ]]; then
              MAIN_CHANGED_FILES="$MAIN_CHANGED_FILES $file"
            fi
          done
          
          echo "Changed main source files: $MAIN_CHANGED_FILES"
          echo "Changed test files: $TEST_CHANGED_FILES"
          
          # Check if any tests were modified (similar to your friend's logic)
          TEST_CHANGES_COUNT=$(echo "$TEST_CHANGED_FILES" | wc -w || echo "0")
          if [ "$TEST_CHANGES_COUNT" -gt 0 ]; then
            echo "TEST_CHANGES=true" >> $GITHUB_ENV
            echo "‚úÖ Test changes detected: $TEST_CHANGES_COUNT test files"
          else
            echo "TEST_CHANGES=false" >> $GITHUB_ENV
            echo "‚ùå No test changes detected"
          fi
          
          # Convert main source files to class names for mutation testing
          CHANGED_CLASSES=""
          for file in $MAIN_CHANGED_FILES; do
            if [[ $file == */src/main/java/* ]]; then
              class_path=${file#*/src/main/java/}
              class_name=${class_path%.java}
              class_name=${class_name//\//.}
              if [ -z "$CHANGED_CLASSES" ]; then
                CHANGED_CLASSES="$class_name"
              else
                CHANGED_CLASSES="$CHANGED_CLASSES,$class_name"
              fi
            fi
          done
          
          # If no main source files changed, but test files did, infer target classes from test names
          if [ -z "$CHANGED_CLASSES" ] && [ "$TEST_CHANGES_COUNT" -gt 0 ]; then
            echo "No main source files changed, but test files were modified."
            echo "Inferring target classes from test file names..."
            
            for test_file in $TEST_CHANGED_FILES; do
              if [[ $test_file == */src/test/java/* ]]; then
                # Extract class info from test file path
                test_class_path=${test_file#*/src/test/java/}
                test_package_path=${test_class_path%/*}
                test_class_name=${test_class_path##*/}
                test_class_name=${test_class_name%.java}
                
                # Simple pattern matching: TestClass -> TargetClass
                target_class=""
                if [[ $test_class_name == *Test ]]; then
                  target_class="${test_class_name%Test}"
                elif [[ $test_class_name == *ExtendedTest ]]; then
                  target_class="${test_class_name%ExtendedTest}"
                fi
                
                if [ -n "$target_class" ]; then
                  full_class_name="${test_package_path//\//.}.${target_class}"
                  target_file="core/src/main/java/${test_package_path}/${target_class}.java"
                  
                  if [ -f "$target_file" ]; then
                    echo "‚úÖ Found target class: $full_class_name (inferred from $test_file)"
                    if [ -z "$CHANGED_CLASSES" ]; then
                      CHANGED_CLASSES="$full_class_name"
                    else
                      CHANGED_CLASSES="$CHANGED_CLASSES,$full_class_name"
                    fi
                  else
                    echo "‚ùå Target class file not found: $target_file"
                  fi
                fi
              fi
            done
          fi
          
          # Set outputs
          if [ -z "$CHANGED_CLASSES" ]; then
            echo "skip_mutation_testing=true" >> $GITHUB_OUTPUT
            echo "‚ùå No testable classes found for mutation testing"
          else
            echo "changed_classes=$CHANGED_CLASSES" >> $GITHUB_OUTPUT
            echo "skip_mutation_testing=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Classes to test: $CHANGED_CLASSES"
          fi
      
      - name: Display Change Detection Results
        if: matrix.java-version == '24'
        run: |
          echo "=== üîç Change Detection Summary ==="
          echo "Test changes detected: $TEST_CHANGES"
          if [ "$TEST_CHANGES" = "true" ]; then
            echo "‚úÖ Tests were modified - mutation testing will run"
          else
            echo "‚ÑπÔ∏è  No test changes detected"
          fi
          
          if [ "${{ steps.changed-files.outputs.skip_mutation_testing }}" = "false" ]; then
            echo "üß¨ Mutation testing enabled for classes:"
            echo "${{ steps.changed-files.outputs.changed_classes }}"
          else
            echo "‚è≠Ô∏è  Mutation testing skipped - no applicable changes found"
          fi

      - name: Run PITest mutation testing on changed classes
        if: matrix.java-version == '24' && steps.changed-files.outputs.skip_mutation_testing == 'false'
        run: |
          echo "Running mutation testing on: ${{ steps.changed-files.outputs.changed_classes }}"
          mvn -pl core org.pitest:pitest-maven:mutationCoverage \
            -DtargetClasses="${{ steps.changed-files.outputs.changed_classes }}" \
            -DtargetTests="${{ steps.changed-files.outputs.changed_classes }}*Test" \
            -DoutputFormats=XML,HTML \
            -Dthreads=2
          
          # Extract current mutation score
          if [ -f "core/target/pit-reports/mutations.xml" ]; then
            MUTATIONS_GENERATED=$(grep -o '<mutation ' core/target/pit-reports/mutations.xml | wc -l || echo "0")
            MUTATIONS_KILLED=$(grep -o 'status="KILLED"' core/target/pit-reports/mutations.xml | wc -l || echo "0")
            if [ "$MUTATIONS_GENERATED" -ne "0" ]; then
              CURRENT_MUTATION_SCORE=$(echo "scale=1; $MUTATIONS_KILLED * 100 / $MUTATIONS_GENERATED" | bc)
              echo "üß¨ Current Mutation Score: $CURRENT_MUTATION_SCORE% ($MUTATIONS_KILLED/$MUTATIONS_GENERATED)"
              
              # Store current results for comparison
              echo "CURRENT_SCORE=$CURRENT_MUTATION_SCORE" >> $GITHUB_ENV
              echo "CURRENT_KILLED=$MUTATIONS_KILLED" >> $GITHUB_ENV
              echo "CURRENT_TOTAL=$MUTATIONS_GENERATED" >> $GITHUB_ENV
            else
              echo "üß¨ No mutations generated"
              echo "CURRENT_SCORE=0" >> $GITHUB_ENV
            fi
          fi
      
      - name: Get baseline mutation score from previous commit
        if: matrix.java-version == '24' && steps.changed-files.outputs.skip_mutation_testing == 'false'
        run: |
          # Get previous commit hash
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            PREV_COMMIT="${{ github.event.before }}"
          else
            PREV_COMMIT="HEAD~1"
          fi
          
          echo "Comparing with previous commit: $PREV_COMMIT"
          
          # Stash current changes
          git stash || true
          
          # Checkout previous commit
          git checkout $PREV_COMMIT
          
          # Build and run PITest on previous commit
          mvn -B clean install -pl web-api -am -q || true
          mvn -pl core org.pitest:pitest-maven:mutationCoverage \
            -DtargetClasses="${{ steps.changed-files.outputs.changed_classes }}" \
            -DtargetTests="${{ steps.changed-files.outputs.changed_classes }}*Test" \
            -DoutputFormats=XML \
            -Dthreads=2 \
            --quiet || true
          
          # Extract baseline score
          if [ -f "core/target/pit-reports/mutations.xml" ]; then
            BASELINE_MUTATIONS_GENERATED=$(grep -o '<mutation ' core/target/pit-reports/mutations.xml | wc -l || echo "0")
            BASELINE_MUTATIONS_KILLED=$(grep -o 'status="KILLED"' core/target/pit-reports/mutations.xml | wc -l || echo "0")
            if [ "$BASELINE_MUTATIONS_GENERATED" -ne "0" ]; then
              BASELINE_SCORE=$(echo "scale=1; $BASELINE_MUTATIONS_KILLED * 100 / $BASELINE_MUTATIONS_GENERATED" | bc)
              echo "üìä Baseline Mutation Score: $BASELINE_SCORE% ($BASELINE_MUTATIONS_KILLED/$BASELINE_MUTATIONS_GENERATED)"
              echo "BASELINE_SCORE=$BASELINE_SCORE" >> $GITHUB_ENV
            else
              echo "üìä No baseline mutations found"
              echo "BASELINE_SCORE=0" >> $GITHUB_ENV
            fi
          else
            echo "üìä No baseline mutation report found"
            echo "BASELINE_SCORE=0" >> $GITHUB_ENV
          fi
          
          # Return to current commit
          git checkout -
          git stash pop || true
      
      - name: Check for mutation score regression
        if: matrix.java-version == '24' && steps.changed-files.outputs.skip_mutation_testing == 'false'
        run: |
          CURRENT_SCORE="${{ env.CURRENT_SCORE }}"
          BASELINE_SCORE="${{ env.BASELINE_SCORE }}"
          TOLERANCE=5  # 5% tolerance
          
          echo "=== üß¨ Mutation Testing Regression Check ==="
          echo "Classes tested: ${{ steps.changed-files.outputs.changed_classes }}"
          echo "Baseline Score: ${BASELINE_SCORE}%"
          echo "Current Score:  ${CURRENT_SCORE}%"
          
          if [ -n "$CURRENT_SCORE" ] && [ -n "$BASELINE_SCORE" ]; then
            # Calculate difference
            DIFF=$(echo "$CURRENT_SCORE - $BASELINE_SCORE" | bc)
            echo "Difference: ${DIFF}%"
            
            # Check for regression (current score lower than baseline by more than tolerance)
            if (( $(echo "$DIFF < -$TOLERANCE" | bc -l) )); then
              echo "‚ùå MUTATION SCORE REGRESSION DETECTED!"
              echo "The mutation score dropped by ${DIFF}% (tolerance: ${TOLERANCE}%)"
              echo "üö® BUILD FAILED: Please improve your tests to maintain mutation score quality."
              echo "MUTATION_REGRESSION=true" >> $GITHUB_ENV
              exit 1
            else
              echo "‚úÖ No significant mutation score regression detected (${DIFF}%)"
              echo "MUTATION_REGRESSION=false" >> $GITHUB_ENV
            fi
          else
            echo "‚ö†Ô∏è  Could not compare scores - skipping regression check"
          fi
      
      - name: Motivation on Mutation Testing Failure üéµ
        if: env.MUTATION_REGRESSION == 'true' && matrix.java-version == '24'
        run: |
          echo "Your changes made the mutation score go down"
          echo "To learn more about mutation testing and how to do TDD effectively, check out:"
          echo "https://www.youtube.com/watch?v=ZXsQAXx_ao0 "
      
      - name: Upload mutation test reports
        if: always() && matrix.java-version == '24' && steps.changed-files.outputs.skip_mutation_testing == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: pit-reports
          path: core/target/pit-reports/
          
      - name: Save PITest History
        if: always() && matrix.java-version == '24'
        uses: actions/upload-artifact@v4
        with:
          name: pitest-history
          path: core/target/pit-history/